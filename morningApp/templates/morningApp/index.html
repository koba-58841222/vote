<!DOCTYPE html>
{% load static %}
{% load bootstrap4 %}
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>投票.com</title>
    <link href = "{% static 'morningApp/style.css' %}" rel = "stylesheet" type = "text/css">
</head>
<body>
    <h1 class = "title"><span>投票.com</span></h1>
    {% if request.user.is_authenticated %}
    <a href="{% url 'logout' %}">ログアウトする</a>
    <p>こんにちは，{{ user.id }}, {{ user.username }}</p>
    <h2><a href="{% url 'createQ' %}">アンケート作成</a></h2>
    <form action="{% url 'index' %}" method="get">
        <input name="keyword" type="text">
        <button type="submit">検索する</button>
    </form>
    <a href="{% url 'index' %}">新着順</a>
    <a href="{% url 'trend' %}">トレンド順</a>
    <a href="{% url 'popular' %}">人気順</a>
    <table>
        {% for i in page_obj %}
        <tr>
            <th>{{ i.contents }}</th>
        </tr>

        <tr>
            <form id="ajax_a" action= "{% url 'vote_a' i.pk %}" method="POST">
                <td><input type="submit" id="choice_a" value="{{ i.choice_a }}"></td>
                {% csrf_token %}
            </form>
            <td><a href="{% url 'vote_b' i.pk %}">{{ i.choice_b }}</a></td>
            <td><a href="{% url 'vote_c' i.pk %}">{{ i.choice_c }}</a></td>
            <td><a href="{% url 'vote_d' i.pk %}">{{ i.choice_d }}</a></td>
        </tr>

        <tr>
            <td><span id="per_a"></span>%</td>
            <td><span id="per_b"></span>%</td>
            <td><span id="per_c"></span>%</td>
            <td><span id="per_d"></span>%</td>
        </tr>

        <tr>
            <td>投票数：<span id="total_votes"></span></td>
        </tr>
        {% endfor %}
    </table>
    <div>
        <nav aria-label="Page navigation example">
            <ul class="pagination">
                {% if page_obj.has_previous %}
                    <li><a class="page-link text-primary d-inline-block" href="?page={{ page_obj.previous_page_number }}">前</a></li>
                {% else %}
                    <li class="disabled"><div class="page-link text-secondary d-inline-block disabled" href="#">前</div></li>
                {% endif %}
    
                {% for link_page in page_obj.paginator.page_range %}
                    {% if link_page %}
                        {% if link_page == page_obj.number %}
                            <li class="disabled"><div class="page-link text-secondary d-inline-block disabled" href="#">{{ link_page }}</div></li>
                        {% else %}
                            <li><a class="page-link text-primary d-inline-block" href="?page={{ link_page }}">{{ link_page }}</a></li>
                        {% endif %}
                    {% else %}
                        <li class="disabled"><a class="page-link text-secondary d-inline-block text-muted" href="#">・・・</a></li>
                    {% endif %}
                {% endfor %}
    
                {% if page_obj.has_next %}
                    <li><a class="page-link text-primary d-inline-block" href="?page={{ page_obj.next_page_number }}">次</a></li>
                {% else %}
                    <li class="disabled"><div class="page-link text-secondary d-inline-block disabled" href="#">次</div></li>
                {% endif %}
            </ul>
        </nav>
    </div>
    {% else %}
    <a href="{% url 'login' %}">ログイン</a>
    <a href="{% url 'signup' %}">アカウント作成</a>
    {% endif %}
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script type="text/javascript">
        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = jQuery.trim(cookies[i]);
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        var csrftoken = getCookie('csrftoken');

        function csrfSafeMethod(method) {
            // these HTTP methods do not require CSRF protection
            return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
        }

        $.ajaxSetup({
            beforeSend: function (xhr, settings) {
                if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", csrftoken);
                }
            }
        });
        $('#ajax_a').on('submit', function(event) {
            event.preventDefault();
            $('#per_a').empty();
            $('#per_b').empty();
            $('#per_c').empty();
            $('#per_d').empty();
            $('#total_votes').empty();
            var form = $(this);
            $.ajax({
                url:form.prop("action"),
                method:form.prop("method"),
                dataType:"json",
                timespan:1000,
            })
            // Ajaxリクエストが成功した時発動
            .done( data => {
                $('#per_a').prepend(data["per_a"]);
                $('#per_b').prepend(data["per_b"]);
                $('#per_c').prepend(data["per_c"]);
                $('#per_d').prepend(data["per_d"]);
                $('#total_votes').prepend(data["total_votes"]);
            })
            // Ajaxリクエストが失敗した時発動
            .fail( (data) => {
                alert("失敗");
            })
            // Ajaxリクエストが成功・失敗どちらでも発動
            .always( (data) => {
                alert("常");
            });
        });
    </script>
</body>
</html>